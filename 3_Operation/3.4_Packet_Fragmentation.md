# 3.4 Packet Fragmentation

当RTMFP数据包（参见 [2.2.4][1]）的大小由于迫不得已的原因而比[MTU][7]大（例如，session创建数据包中包含了RHello（参见 [2.3.4][2]），或者IIKeying数据包（参见 [2.3.7][3]）中的证书大小很大），则这个数据包会被分成数据包碎片（Packet Fragment，参见 [2.3.1][4]）发送，以满足MTU对大小的限制。

数据包碎片化技术 *应该* 仅仅应用当数据包迫不得已（unavoidably）非常大的时候。因此，这种机制 *应该* 仅仅引用于session创建过程中，即session标识符为0的阶段。 *禁止* 用这种机制替代 *User Data* [2.3.11][5]中的其他正常的碎片化机制或 *Next User Data* [2.3.12][6]中为防止数据包超过MTU而将用户数据流（user data flow）中的消息分拆为多个片段的技术。


在接收端，会将碎片化的RTMFP数据包按照索引，从0开始，升序连接并重组到一起。

在重组数据包时，如果session标识符为0，则接收者 *应该* 根据数据包来源的socket地址和数据包的id值来区分各个不同的包。

数据包的接收者 *应该* 允许最长60秒的数据包碎片传输时间，前提是传输过程还在进行。如果在限时的最后一秒内至少接收到了一个新的数据包，就说明传输过程还在进行。

如果某个数据包碎片中包含空的`packetFragment`域，则接收者 *必须* 丢弃该数据包碎片。

拆分自同一个包的碎片 *必须* 具有相同的模式（mode）。如果新接收到的数据包碎片的模式与接收到的第一个数据包碎片的模式不同，则接收者 *必须* 丢弃该碎片。如果重组后的数据包的模式与接收到的数据包碎片的模式不同，则接收者 *必须* 丢弃该数据包。

为了防止阻塞网络，发送者 *必须* 限制数据包的传输速度。如果无法确定网情况（例如正在建立session的过程中），则发送者发送的数据包 *应该* 不应该超过4380字节，而且在200ms内向每个端节点发送的数据包数目不应该超过4个。

为了避免资源被耗尽，接收者 *应该* 限制并发执行数据包重组任务的数目和每个任务中缓冲区的大小。

[1]:    ../2_Syntax/2.2.4_Packet.md
[2]:    ../2_Syntax/2.3.4_Responder_Hello_Chunk.md
[3]:    ../2_Syntax/2.3.7_Initiator_Initial_Keying_Chunk.md
[4]:    ../2_Syntax/2.3.1_Packet_Fragment_Chunk.md
[5]:    ../2_Syntax/2.3.11_User_Data_Chunk.md
[6]:    ../2_Syntax/2.3.12_Next_User_Data_Chunk.md
[7]:    http://en.wikipedia.org/wiki/Maximum_transmission_unit

